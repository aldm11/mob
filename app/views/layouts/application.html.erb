<!DOCTYPE html>
<html ng-app>
<head>
  <title>Mobis</title>
  <%= stylesheet_link_tag "application", :media => "all" %>
  <%= javascript_include_tag "application", :media => "all" %>
  <%= javascript_include_tag "http://localhost:4000/socket.io/socket.io.js" %>

  <%= csrf_meta_tags %>
</head>
<body>

<%= render "layouts/header" %>
<% flash.each do |key, message| %>
<%= content_tag(:div, :class => "alert alert-#{key.to_s}") do %>
<%= message %>
<% end %>
<% end %>
<div class="container">
	<div class="content">
		<%= yield %>
	</div>
</div>

<% if account_signed_in? %>
<script type="text/javascript">
	function ChatController($scope, $timeout){
		$scope.PROPERTIES = ["account_id", "username", "image", "name", "email"];
		$scope.contacts = {};
		$scope.conversations = {};
		$scope.name = "amer";
		$scope.socket = io.connect("http://localhost:4000");
		$scope.account = <%= raw current_account_json.to_json %>;
		
		$scope.index = function(){
			$scope.socket.emit("login", $scope.account);
			
			$scope.socket.on("login_complete", function(){
				$scope.socket.emit("onlineList", $scope.account.account_id);
				
				$scope.socket.on("onlineListReply", function(accounts){
					updateContacts(accounts);
					console.log($scope.contacts);
				});
			});
			
			$scope.socket.on("user_logged_in", function(account){
				$scope.$apply(function(){
					if($scope.contacts[account.account_id] ===  undefined){
						for(var i = 0; i < $scope.PROPERTIES.length; i++){
							$scope.contacts[account.account_id] = account;
						}
					}
				});
			});
			
			$scope.socket.on("message", function(message){
				$scope.$apply(function(){
					var sender_id = message.sender_id;
					checkAndInitConversation(sender_id);
					$scope.conversations[sender_id].messages.push({"sender" : $scope.contacts[sender_id].name, "content" : message.content});
				});
			});
			
		};
		
		$scope.startConversation = function(contact_id){
			checkAndInitConversation(contact_id)
		};
		
		$scope.sendMessage = function(contact_id){
			var message = $scope.conversations[contact_id].new_message
			
			$scope.conversations[contact_id].messages.push({"sender" : $scope.account.name, "content" : message});
		    $scope.socket.emit("clientMessage", {"sender_id" : $scope.account.account_id, "receiver_id" : contact_id, "content" : message});
		};
		
		function checkAndInitConversation(contact_id){
			if($scope.conversations[contact_id] === undefined){
				$scope.conversations[contact_id] = {};
				$scope.conversations[contact_id]["details"] = $scope.contacts[contact_id];
				$scope.conversations[contact_id]["new_message"] = "";
				$scope.conversations[contact_id]["messages"] = [];
			}
		}
		
		function updateContacts(accounts){
			var online_accounts = {};
			$scope.$apply(function(){
				for(var i = 0; i < accounts.length; i++){
					var account = accounts[i];
					if($scope.contacts[account.account_id] === undefined){
						$scope.contacts[account.account_id] = account;
					}
					else{
						for(var i = 0; i < $scope.PROPERTIES.length; i++){
							$scope.contacts[account.account_id][$scope.PROPERTIES[i]] = account[$scope.PROPERTIES[i]];
						}
					}
					online_accounts[account.account_id] = 1;
				}
				
				for(var account_id in $scope.contacts){
					if(online_accounts[account_id] === undefined){
						delete $scope.contacts[account_id];
					}
				}
			});
		}
	}
</script>

<style>
	.chat {
		position: fixed !important;
		left: auto !important;
		right: 6em !important;
		top: auto;
		bottom: 0 !important;
		z-index: : 20;	
	}
/*make contacts and conversations windows have height based on threir content*/
	.window {
		position: relative !important;
		top: auto;
		bottom: 0 !important;
		z-index: : 20;		

	  }
	.chat div {
		float: left;
	}
	.title {
		background: #0088cc;
		color: white;
		padding: 2px;
		box-sizing: border-box;
		font-weight: bold;
	}
	.contacts {
		width: 180px;
		border: 1px solid #0088cc;
		border-top: 0;
		border-bottom: 0;
	}
	.contact a {
		display: inline-block;
		width: 100%;
		height: 100%;
	}
	.contact img {
		width: 30px;
		height: 30px;
	}
	
	.contact:hover{
		background: #EEE;
	}
	
	.conversation {
		width: 180px;
		padding: 2px;
		padding-bottom: 0px;
		box-sizing: border-box;
	}
	.conversation .message {
		font-size: 9pt !important;
	}
	.new-message {
		width: 150px !important;
		margin-bottom: 0px !important;
		float:left !important;
	}
</style>

<div class="chat" ng-controller="ChatController" ng-init="index()">	
	<div class = "contacts window">
		<div class="row-fluid title">Chat</div>
		<div class="row-fluid contact" ng-repeat="(contact_id, contact) in contacts">
			<a href="#" ng-click="startConversation(contact.account_id)">
				<img ng-src="{{contact.image}}" />
				{{contact.name}}
			</a>
		</div>
	</div>
	
	<div class="conversations">
		<div class="conversation window" ng-repeat="(contact_id, conversation) in conversations">
			<div class="row-fluid title">{{conversation.details.name}}</div>
			<div class="row-fluid message" ng-repeat="message in conversation.messages">
				<span class="muted sender">{{message.sender}} says</span><br/>
				<span class="text">{{message.content}}</span>
			</div>
			<input type="text" class="input-medium new-message" ng-model="conversation.new_message" placeholder="Type message and press enter" />
			<a href="#" ng-click="sendMessage(contact_id)">Send</a>
		</div>
	</div>
</div>
<% end %>

<%= render "layouts/footer" %>
</body>
</html>
